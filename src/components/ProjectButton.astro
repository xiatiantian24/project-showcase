---
import type { ImageMetadata } from "astro";
import { ViewTransitions } from "astro:transitions";
import { Image } from "astro:assets";

interface Props {
  href: string;
  title: string;
  description: string;
  scopes: string[];
  altText: string;
  imgPath?: string;
  videoSrc?: string;
  mediaType?: "image" | "video";
}

const {
  href,
  title,
  description,
  scopes,
  altText,
  imgPath,
  videoSrc,
  mediaType = "image",
} = Astro.props;

const images = import.meta.glob<{ default: ImageMetadata }>(
  "../assets/images/*"
);
if (mediaType === "image" && !images[imgPath]) {
  throw new Error(`"${imgPath}" does not exist in glob: "../assets/images/*"`);
}
---

<head>
  <ViewTransitions />
</head>

<project-button
  class="button-wrap"
  data-mediatype={mediaType}
  data-imgpath={imgPath}
>
  <a href={href}>
    <div class="button">
      <!-- Text content at top -->
      <div class="text-content">
        <div class="project-description">
          {description}
        </div>
        <div class="project-title">{title}</div>
        <div class="project-scope">
          {
            scopes.map((scope, index) => (
              <>
                <span>{scope}</span>
                {index !== scopes.length - 1 && (
                  <span class="scope-separator"> / </span>
                )}
              </>
            ))
          }
        </div>
      </div>

      <!-- Cover Image at bottom -->
      <div class="media-container">
        {
          mediaType === "image" ? (
            <Image
              src={images[imgPath]()}
              alt={altText}
              class="media-content image"
              loading="eager"
            />
          ) : (
            <video class="media-content video" autoplay loop muted playsinline>
              <source src={videoSrc} type="video/mp4" />
            </video>
          )
        }
      </div>
    </div>
  </a>
</project-button>

<script>
  // Temporarily disabled cursor following effect
  /*
  class ProjectButton extends HTMLElement {
    constructor() {
      super();

      const button = this.querySelector("a");
      const target = this.querySelector(".media-wrap") as HTMLElement;
      const mediaType = this.dataset.mediatype;
      const mediaContent = target?.querySelector(".media-content");

      // Cursor following effect for project button
      function follow(e) {
        if (target) {
          target.style.left = `${e.pageX + 24}px`;
          target.style.top = `${e.pageY - window.scrollY - 0.5 * target.scrollHeight}px`;
        }
      }

      if (target && mediaContent) {
        target.style.transition =
          "filter 400ms ease-out, visibility 100ms linear";
        target.style.filter = "saturate(0%) contrast(50%)";

        button?.addEventListener("mouseenter", () => {
          target.style.display = "block";
          target.style.visibility = "visible";
          setTimeout(() => {
            target.style.filter = "saturate(100%) contrast(100%)";
          }, 1);
          document.addEventListener("mousemove", follow);

          // If it's a video, ensure it's playing
          if (mediaType === "video") {
            (mediaContent as HTMLVideoElement).play();
          }
        });

        button?.addEventListener("mouseleave", () => {
          target.style.visibility = "hidden";
          target.style.transition = "filter 400ms ease-out";
          target.style.filter = "saturate(0%) contrast(50%)";
          document.removeEventListener("mousemove", follow);
        });
      }
    }
  }

  customElements.define("project-button", ProjectButton);
  */
</script>

<style>
  .button-wrap {
    width: 100%;
    /* font-family: "TT Fors"; */
    font-family: "Figtree";
    aspect-ratio: 1;
    height: auto;
  }

  .button {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: 1rem;
    border-radius: 12px;
    transition: background-color 250ms ease-in-out;
    padding: 2rem;
  }

  .project-description {
    font-family: "Figtree";
    transform: scaleY(1.02);
    line-height: 1.1;
    font-weight: 400;
    transform-origin: 0 0;
    letter-spacing: -0.01rem;
    color: var(--color-text-main);
    transition: all 250ms ease-in-out;
    font-size: 0.95rem;
  }

  .text-content {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .media-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .project-title {
    font-family: "LT Cushion";
    font-weight: 375;
    font-style: normal;
    line-height: 1;
    transform: scaleY(1.02);
    transform-origin: 0 0;
    font-size: 1.45rem;
    transition: all 250ms ease-in-out;
    color: var(--color-text-main);
  }

  .project-scope {
    color: var(--color-text-secondary);
    text-transform: uppercase;
    transform: scaleY(1.1);
    transform-origin: 0 0;
    font-size: 0.75rem;
    letter-spacing: -0.005rem;
    line-height: 110%;
    font-weight: 450;
    display: flex;
    flex-wrap: wrap;
    margin-top: 0.35rem;
  }

  .scope-separator {
    margin: 0 0.5rem;
  }

  .media-wrap {
    position: fixed;
    text-align: center;
    display: none;
    z-index: 1000;
    pointer-events: none;
  }

  .media-content {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 4px;
  }

  a {
    height: 100%;
    display: block;
    border-bottom: 1.5px solid var(--color-border-secondary);
    padding: 0;
  }

  .button:hover {
    background-color: var(--color-bg-highlight);
  }

  @media screen and (min-width: 768px) {
    .project-title {
      letter-spacing: -0.03rem;
    }

    a {
      padding: 2rem;
    }

    .media-content {
      border-bottom: none;
      padding-bottom: 0;
    }

    video {
      object-fit: contain;
    }
  }

  @media screen and (min-width: 1024px) {

    /* Target even project buttons for border-left */
    .button-wrap:nth-child(even) a {
      border-left: 1.5px solid var(--color-border-secondary);
    }
  }
</style>
